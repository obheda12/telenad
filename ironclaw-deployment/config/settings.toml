# IronClaw Configuration for Secure Telegram Agent
# Option A: Read-Only Telegram Access with Native Security
#
# Deploy to: ~/.ironclaw/settings.toml

[database]
url = "postgresql://ironclaw:CHANGE_ME@localhost:5432/ironclaw"

# =============================================================================
# SECURITY CONFIGURATION
# =============================================================================
[security]
# CRITICAL: Only allow Telegram API - no other external access
http_allowlist = ["https://api.telegram.org"]

# Aggressive prompt injection defense
prompt_injection_severity = "block"
enable_leak_detection = true

# Secrets are stored in system keychain with AES-256-GCM encryption
# Never expose secrets to tool code - inject at host boundary only

# =============================================================================
# RESOURCE LIMITS (Optimized for Raspberry Pi 4)
# =============================================================================
[resources]
# Memory: Conservative for Pi's limited RAM (4GB model)
max_memory_mb = 256

# Concurrency: Limit to avoid overloading the Pi
max_concurrent_jobs = 2

# Execution timeout: Prevent runaway processes
max_execution_time_seconds = 60

# CPU time limit per tool execution
max_cpu_seconds = 30

# =============================================================================
# TELEGRAM TOOL CONFIGURATION
# =============================================================================
[tools.telegram]
enabled = true

# READ-ONLY METHODS: These are the ONLY Telegram API methods allowed
allowed_methods = [
    "getUpdates",
    "getMe",
    "getChat",
    "getChatMember",
    "getChatMembersCount",
    "getChatAdministrators",
    "getFile",
    "getUserProfilePhotos",
    "getMyCommands",
    "getMyDescription",
    "getMyName"
]

# BLOCKED METHODS: Explicitly block ALL write operations
# This is defense-in-depth - even if something bypasses allowed_methods
blocked_methods = [
    # Message sending
    "sendMessage",
    "sendPhoto",
    "sendDocument",
    "sendAudio",
    "sendVideo",
    "sendAnimation",
    "sendVoice",
    "sendVideoNote",
    "sendMediaGroup",
    "sendLocation",
    "sendVenue",
    "sendContact",
    "sendPoll",
    "sendDice",
    "sendSticker",
    "sendInvoice",
    "sendGame",

    # Message modification
    "forwardMessage",
    "copyMessage",
    "deleteMessage",
    "deleteMessages",
    "editMessageText",
    "editMessageCaption",
    "editMessageMedia",
    "editMessageReplyMarkup",
    "editMessageLiveLocation",
    "stopMessageLiveLocation",
    "stopPoll",

    # Chat actions
    "sendChatAction",
    "setMessageReaction",

    # Chat administration
    "banChatMember",
    "unbanChatMember",
    "restrictChatMember",
    "promoteChatMember",
    "setChatAdministratorCustomTitle",
    "setChatPermissions",
    "setChatPhoto",
    "deleteChatPhoto",
    "setChatTitle",
    "setChatDescription",
    "pinChatMessage",
    "unpinChatMessage",
    "unpinAllChatMessages",
    "leaveChat",
    "setChatStickerSet",
    "deleteChatStickerSet",

    # Bot settings
    "setMyCommands",
    "deleteMyCommands",
    "setMyDescription",
    "setMyShortDescription",
    "setMyName",
    "setChatMenuButton",
    "setMyDefaultAdministratorRights",

    # Webhooks (we use polling, not webhooks)
    "setWebhook",
    "deleteWebhook",

    # Payments
    "answerShippingQuery",
    "answerPreCheckoutQuery",
    "createInvoiceLink",

    # Games
    "setGameScore",
    "answerCallbackQuery",
    "answerInlineQuery"
]

# =============================================================================
# LOCAL TOOLS CONFIGURATION
# =============================================================================
[tools.local_notes]
enabled = true
# Restrict file operations to specific directory
allowed_paths = ["/home/pi/ironclaw-notes"]
operations = ["read", "write", "list"]
# Maximum file size (prevent disk exhaustion)
max_file_size_kb = 1024

[tools.local_db]
enabled = true
# Allow storing summaries/insights in local PostgreSQL
# Read-write access to agent's own tables only

# =============================================================================
# DISABLED TOOLS (Security: disable anything not explicitly needed)
# =============================================================================
[tools.http_request]
enabled = false

[tools.shell_exec]
enabled = false

[tools.file_system]
enabled = false
# Use local_notes with restricted paths instead

[tools.mcp]
enabled = false
# No external MCP tool servers

# =============================================================================
# AUDIT LOGGING
# =============================================================================
[audit]
# Full logging for security review and forensics
log_all_queries = true
log_tool_executions = true
log_prompt_injection_attempts = true

# Log file location
log_file = "/var/log/ironclaw/audit.log"

# Log rotation (keep 7 days of logs)
max_log_age_days = 7
max_log_size_mb = 100

# =============================================================================
# WASM SANDBOX CONFIGURATION
# =============================================================================
[wasm]
# Memory limit per WASM instance
instance_memory_mb = 64

# Fuel limit (execution steps) - prevents infinite loops
max_fuel = 1000000

# Disable WASI capabilities not needed
allow_filesystem = false
allow_network = false
allow_environment = false
