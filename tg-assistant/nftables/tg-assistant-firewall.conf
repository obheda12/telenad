#!/usr/sbin/nft -f
#
# =============================================================================
# tg-assistant-firewall.conf -- Per-Process Network Isolation (nftables)
# =============================================================================
#
# This ruleset restricts outbound network access for the tg-syncer and
# tg-querybot service users. It is the KERNEL-LEVEL enforcement layer --
# even if the application code is fully compromised (RCE), the attacker
# cannot reach any host not explicitly allowed here.
#
# Defense-in-depth layers (innermost to outermost):
#   1. Application: read-only wrapper, method allowlist
#   2. systemd: process sandbox, capability dropping
#   3. THIS: kernel nftables, per-UID IP allowlist  <-- you are here
#   4. Physical: Raspberry Pi in your home
#
# Install:
#   sudo cp tg-assistant-firewall.conf /etc/nftables.d/tg-assistant.conf
#   sudo nft -f /etc/nftables.d/tg-assistant.conf
#
#   To persist across reboots, include from /etc/nftables.conf:
#     include "/etc/nftables.d/tg-assistant.conf"
#
# Verify:
#   sudo nft list table inet tg_assistant_isolation
#
# Test (as tg-syncer user):
#   sudo -u tg-syncer curl https://api.telegram.org  # Should FAIL (wrong IP range)
#   sudo -u tg-syncer curl https://149.154.167.220    # Should succeed (Telegram DC)
#
# IP Ranges:
#   Telegram MTProto data centers are documented at:
#     https://core.telegram.org/resources/cidr.txt
#   These ranges are stable but should be verified periodically.
#
# =============================================================================

table inet tg_assistant_isolation {

    # =========================================================================
    # OUTPUT CHAIN -- Filter outbound traffic by service user
    # =========================================================================
    #
    # Policy: accept (default allow for all other system users).
    # Only tg-syncer and tg-querybot users have restrictive rules.
    # Traffic from root, postgres, and other users is unaffected.

    chain output {
        type filter hook output priority 0; policy accept;

        # ---------------------------------------------------------------------
        # Global: Allow traffic that all services need
        # ---------------------------------------------------------------------

        # Loopback interface -- always allow (localhost DB connections, etc.)
        oif "lo" accept

        # Established/related connections -- allow return traffic for
        # connections that were already permitted. Without this, TCP
        # handshakes would succeed but data transfer would fail.
        ct state established,related accept

        # DNS resolution -- both services need to resolve hostnames.
        # tg-syncer resolves Telegram DC hostnames.
        # tg-querybot resolves api.telegram.org and api.anthropic.com.
        #
        # SECURITY NOTE: DNS is allowed to any resolver. If you want to
        # restrict this further, replace with your specific DNS server IP:
        #   ip daddr 192.168.1.1 udp dport 53 accept
        udp dport 53 accept
        tcp dport 53 accept

        # ---------------------------------------------------------------------
        # tg-syncer: ONLY Telegram MTProto data center IPs on port 443
        # ---------------------------------------------------------------------
        #
        # Telethon connects to Telegram's MTProto servers over TCP port 443.
        # These are Telegram's published DC IP ranges (from cidr.txt).
        #
        # What this blocks:
        #   - Exfiltration of messages/session to any non-Telegram host
        #   - Connection to C2 servers if the process is compromised
        #   - Any HTTP(S) traffic to arbitrary websites
        #
        # The syncer has NO reason to contact any other host on the internet.

        # Telegram DC IP ranges (IPv4)
        # DC1-DC5: 149.154.160.0/20 (covers 149.154.160.0 - 149.154.175.255)
        meta skuid "tg-syncer" ip daddr 149.154.160.0/20 tcp dport 443 accept

        # Additional Telegram ranges (various DCs and CDN nodes)
        meta skuid "tg-syncer" ip daddr 91.108.4.0/22   tcp dport 443 accept
        meta skuid "tg-syncer" ip daddr 91.108.8.0/22   tcp dport 443 accept
        meta skuid "tg-syncer" ip daddr 91.108.12.0/22  tcp dport 443 accept
        meta skuid "tg-syncer" ip daddr 91.108.16.0/22  tcp dport 443 accept
        meta skuid "tg-syncer" ip daddr 91.108.56.0/22  tcp dport 443 accept

        # Telegram DC IP ranges (IPv6)
        meta skuid "tg-syncer" ip6 daddr 2001:b28:f23d::/48 tcp dport 443 accept
        meta skuid "tg-syncer" ip6 daddr 2001:b28:f23f::/48 tcp dport 443 accept
        meta skuid "tg-syncer" ip6 daddr 2001:67c:4e8::/48  tcp dport 443 accept

        # DROP everything else from tg-syncer.
        # This is the critical rule: any destination not explicitly allowed
        # above is silently dropped. The syncer cannot reach the internet.
        meta skuid "tg-syncer" log prefix "tg-syncer-blocked: " drop

        # ---------------------------------------------------------------------
        # tg-querybot: ONLY Telegram Bot API + Anthropic Claude API
        # ---------------------------------------------------------------------
        #
        # The querybot needs to reach exactly two external services:
        #   1. api.telegram.org -- to receive/send bot messages (HTTPS)
        #   2. api.anthropic.com -- to call Claude for query responses (HTTPS)
        #
        # What this blocks:
        #   - Data exfiltration to any other host
        #   - Claude API key theft via connecting to attacker-controlled server
        #   - Lateral movement to internal network hosts
        #
        # NOTE: api.telegram.org and api.anthropic.com resolve to IPs that
        # may change. We allow the broader Telegram DC range (which includes
        # the Bot API servers) and Anthropic's known IP ranges.

        # Telegram Bot API servers (same DC infrastructure as MTProto)
        # api.telegram.org resolves to IPs within Telegram's DC ranges.
        meta skuid "tg-querybot" ip daddr 149.154.160.0/20 tcp dport 443 accept
        meta skuid "tg-querybot" ip daddr 91.108.4.0/22   tcp dport 443 accept
        meta skuid "tg-querybot" ip daddr 91.108.8.0/22   tcp dport 443 accept
        meta skuid "tg-querybot" ip daddr 91.108.12.0/22  tcp dport 443 accept
        meta skuid "tg-querybot" ip daddr 91.108.16.0/22  tcp dport 443 accept
        meta skuid "tg-querybot" ip daddr 91.108.56.0/22  tcp dport 443 accept

        # Anthropic Claude API (api.anthropic.com)
        # Anthropic uses Cloudflare and AWS infrastructure. These ranges
        # cover the known IPs but may need updating if Anthropic changes
        # providers. Verify with: dig +short api.anthropic.com
        #
        # SECURITY NOTE: These ranges are broader than ideal because cloud
        # providers share IP space. For tighter control, resolve the current
        # IPs and use /32 rules, but update them regularly:
        #   dig +short api.anthropic.com | xargs -I{} echo "ip daddr {} tcp dport 443 accept"
        meta skuid "tg-querybot" ip daddr 104.18.0.0/16   tcp dport 443 accept
        meta skuid "tg-querybot" ip daddr 172.67.0.0/16   tcp dport 443 accept

        # Anthropic IPv6 (Cloudflare)
        meta skuid "tg-querybot" ip6 daddr 2606:4700::/32 tcp dport 443 accept

        # DROP everything else from tg-querybot.
        meta skuid "tg-querybot" log prefix "tg-querybot-blocked: " drop

        # ---------------------------------------------------------------------
        # All other users: default accept (no restrictions)
        # ---------------------------------------------------------------------
        # Root, postgres, pi, and other system users are not restricted by
        # this table. Their traffic flows normally. Only the two service
        # users are locked down.
    }
}
